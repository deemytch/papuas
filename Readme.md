h1. Что это

Набор утилит "Парламентёр" предназначен для выполнения скриптов на серверах так, чтобы операторы не имели доступа к указанным серверам. Прокся, короче.

h1. Как это

Оператор пишет скрипт для выполнения задачи на сервере (Нода1). Затем пишет настроечный файл (doit-случайный-текст.yml) с параметрами запуска этого скрипта. Кладёт оба файла и, возможно, другие, необходимые для скрипта файлы, в заранее заданную папку на сервере (Источник1:/папка) и надеется на лучшее.

Утилита bigbro.rb каждые Ч секунд опрашивает папку (Источник1:/папка) на предмет наличия там новых поступлений. Увидев файл настроек doit*.yml он радостно загружает оттуда такие данные: 
* где взять скрипт
* есть ли дополнительные файлы
* на каких серверах (Нода1, Нода10) исполнять этот скрипт и какие данные (логин) для доступа к нодам использовать.

Весь вывод STDOUT и STDERR выполненного скрипта утилита складывает обратно в папку где взяла, переименовывает файл doit*.yml в doneit*.yml и дописывает в него имена файлов stderr.log, stdout.log и код возврата скрипта.

Образец файла задачи находится в *docs/doit-with-love.yml*

h1. Тут нужен админ

h2. Что где

db.sqlite хранит настройки доступа к источникам задач и целевым узлам

Структура баз описана в файле docs/db.dia
Скрипт генерации базы - в dbsetup.rb

*Для создания правильного окружения запускать утилиты следует конструкцией*: ```bundle exec <утилита>```

h2. Программа *appsetup.rb*

предназначена для управления настройками.
Возможности утилиты:

-Sa Добавить источник
-Sd Удалить источник
-Sm Изменить источник

-Na Добавить целевой узел
-Nd Удалить целевой узел
-Nm Изменить целевой узел

-L ротация базы. Файл базы копируется в ```db-#{Time.now}.sqlite```, в текущей базе же
   удаляются все неактивные записи и связанные с ними отчёты.

-H Скопировать справочник с целевыми узлами и и списком разрешённых логинов на каждый источник
   в файл *nodes.listing.yml*

h3. Как это происходит

Вход и выполнение скрипта пользователя на целевом узле.

h4. Ключ и логин для входа

1. используется имя пользователя, заданное в описании задачи, (разумеется если оно есть и в базе тоже)
2. используется имя пользователя, заданное в ~/.ssh/config
3. используется самое старое имя из базы по дате добавления
4. используется ключ (pem) из базы, связанный с найденным именем

h4. При добавлении узла или источника в базу настроек:

1. ищется ключ, явно заданный в командной строке
2. используются настройки из .ssh/config на управляющем компьютере
3. ищем ключ #{user}@#{node}.#{port}.[rsa|ed25519|pem] в подпапке *keys*
4. Затем ключ преобразовывается в .pem формат и записывается в базу

На данном этапе проектирования предполагается использовать net-ssh + sshkit.
Если при отладке возникнут какие-то сбои (руби не всегда многопоточен), будет использоваться бинарный ssh из системы, выполняемый через задачи в sidekiq. В последнем случае понадобится установить и запустить redis, поскольку sidekiq использует его для сериализации задач.

Все задачи на всех серверах ставятся в очередь и выполняются приблизительно параллельно, это зависит от параметра bigbro.rb -j N и загрузки системы.

h3. Примеры

  bundle exec appsetup.rb <параметры>

  -Sa borman,borman@op01.com.ua:6897/home/borman/a/tasks # ключ в файле *borman@op1.com.ua.{rsa,pem}*
  -Sa borman,borman@op01:/home/borman/a/tasks            # все настройки в файле ~/.ssh/config, но другой логин
  -Sa borman,op01:/home/borman/a/tasks                   # все настройки в файле ~/.ssh/config
  -Sa borman,{borman:privkey_borman.pem}@op01:6897/home/borman/a/tasks # где взять ключики
  -Sd borman                                             # заморозить запись
  -Sm borman,anja@op01:6899/home/borman/anja/tmp         # изменить запись
  -Na jboss-spb,{gregor:privkey_gregor.rsa,manja:privkey_manja.pem,vasja}@jboss.co.spb:2222 # несколько юзеров

h2. Программа *bigbro.rb*

Предназначена для сбора задач с источников и выполнения их на целевых узлах.
Результаты выводит в базу данных и, в сокращённом виде, на экран и в log-файл в папке log.
Параметр -j N, где N - целое число. Количество параллельных задач для выполнения на целевых узлах.
Параметр -q - переводит её в тихий режим, результаты выводятся только в базу и в log-файл.
Параметр -qq - вывод только в базу.
Параметр -t - тестовый режим.
* Проверка настроек
* Проверка базы на целостность и непротиворечивость
* Загрузка заданий
* Проверка наличия целевых узлов
* Логин на целевые узлы с указанными реквизитами
* Выполнения скриптов *НЕ ПРОИСХОДИТ*

Запуск: bundle exec bigbro.rb start
Остановка: bundle exec bigbro.rb stop
